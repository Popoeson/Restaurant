<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Dashboard | TastyBite</title>

<!-- PWA manifest & icons (keep as you had) -->
<link rel="manifest" href="/manifest-admin.json" />
<meta name="theme-color" content="#ff6600" />
<link rel="apple-touch-icon" href="/uploads/food.png" />
<link rel="apple-touch-icon" sizes="512x512" href="/uploads/food.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="TastyBite" />

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

<style>
  /* (kept your CSS) */
  body {margin:0;font-family:"Poppins",sans-serif;background-color:#f8f9fb;color:#333;}
  header {display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to right,#ff7f50,#ff914d);color:white;padding:12px 16px;position:sticky;top:0;z-index:10;}
  .menu-toggle {font-size:22px;cursor:pointer;}
  .brand {font-weight:600;font-size:18px;}
  .brand span {background:white;color:#ff7f50;font-size:12px;padding:2px 6px;border-radius:6px;margin-left:4px;}
  .notification {position:relative;font-size:22px;cursor:pointer;opacity:0.8;}
  .notification::after {content:attr(data-count);position:absolute;top:-5px;right:-8px;background:white;color:#ff7f50;font-size:12px;border-radius:50%;padding:2px 5px;}
  .sidebar {position:fixed;top:0;left:-250px;width:220px;height:100%;background:#1f2937;color:white;padding:70px 20px;transition:left 0.3s ease;z-index:9;}
  .sidebar.active {left:0;}
  .sidebar a {display:block;color:white;text-decoration:none;padding:10px 0;font-size:15px;}
  .sidebar a:hover {color:#ff914d;}
  main {padding:16px;margin-top:10px;}
  h2 {margin-bottom:4px;font-size:20px;}
  p.subtitle {color:gray;font-size:14px;margin-bottom:16px;}
  .cards {display:flex;flex-direction:column;gap:14px;}
  .card {background:white;border-radius:12px;padding:16px;box-shadow:0 1px 5px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;}
  .card-icon {font-size:24px;}
  .card h3 {margin:0;font-size:16px;color:#555;}
  .card .value {font-weight:bold;font-size:18px;color:#111;}
  section {margin-top:24px;}
  table {width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,0.1);}
  th,td {padding:10px;font-size:14px;text-align:left;}
  th {background:#ff914d;color:white;}
  tr:nth-child(even) {background:#f9f9f9;}
  @media(min-width:768px){.cards{flex-direction:row;flex-wrap:wrap;}.card{flex:1;min-width:180px;}}

  /* Popup */
  #popupNotification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #ff7f50;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
    z-index: 999;
  }
  #popupNotification.show {
    opacity: 1;
    transform: translateY(0);
  }

  .top-controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
  .btn { background:#ff7b00;color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer; }
</style>
</head>

<body>
<header>
  <div class="menu-toggle" id="toggleMenu">‚ò∞</div>
  <div class="brand">TastyBite <span>Admin</span></div>
  <div style="display:flex;gap:12px;align-items:center">
    <button class="btn" id="refreshBtn" title="Refresh data">‚Üª Refresh</button>
    <div class="notification" id="notifIcon" data-count="0" title="New orders">üîî</div>
  </div>
</header>

<div class="sidebar" id="sidebar">
  <a href="#">Dashboard üìã</a>
  <a href="orders.html">Orders üì¶</a>
  <a href="admin-menu.html">Menu Management ü•™</a>
  <a href="dispatch.html">Dispatch üö≤</a>
  <a href="register.html">Register User üë§</a>
  <a href="#" id="logoutBtn">Logout üö™</a>
</div>

<main>
  <h2>Dashboard</h2>
  <p class="subtitle">Welcome to your admin dashboard</p>

  <div class="cards">
    <div class="card">
      <div>
        <h3>Total Revenue</h3>
        <div class="value" id="revenue">‚Ç¶0</div>
      </div>
      <div class="card-icon">üí∞</div>
    </div>
    <div class="card">
      <div>
        <h3>Total Orders</h3>
        <div class="value" id="ordersCount">0</div>
      </div>
      <div class="card-icon">üõçÔ∏è</div>
    </div>
    <div class="card">
      <div>
        <h3>Pending Orders</h3>
        <div class="value" id="pendingOrders">0</div>
      </div>
      <div class="card-icon">‚è≥</div>
    </div>
    <div class="card">
      <div>
        <h3>Processing Orders</h3>
        <div class="value" id="processingOrders">0</div>
      </div>
      <div class="card-icon">üë®‚Äçüç≥</div>
    </div>
  </div>

  <section>
    <h3>Recent Orders</h3>
    <table id="recentOrdersTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Date</th>
          <th>Status</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Popup Notification -->
<div id="popupNotification">New order received!</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const backendURL = "https://restaurant-eqbo.onrender.com";

  // ---------- dynamic socket.io client load ----------
  const socketScript = document.createElement("script");
  socketScript.src = "https://cdn.socket.io/4.8.1/socket.io.min.js";
  socketScript.onload = () => initRealtime();
  socketScript.onerror = () => console.error("‚ùå Failed to load socket.io client");
  document.head.appendChild(socketScript);

  // ---------- helpers ----------
  const notifIcon = document.getElementById("notifIcon");
  const popup = document.getElementById("popupNotification");
  const refreshBtn = document.getElementById("refreshBtn");

  function setNotifCount(n) {
    notifIcon.setAttribute("data-count", n);
    localStorage.setItem("orderNotifCount", n);
  }
  function getNotifCount() { return parseInt(localStorage.getItem("orderNotifCount") || "0"); }

  // show popup text
  function showPopup(text="New order received!") {
    popup.textContent = text;
    popup.classList.add("show");
    setTimeout(()=> popup.classList.remove("show"), 3000);
  }

  // fetch & render stats
  async function fetchAndRenderStats() {
    try {
      const res = await fetch(`${backendURL}/api/admin/stats`, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load stats");
      const data = await res.json();
      document.getElementById("revenue").textContent = `‚Ç¶${(data.totalRevenue||0).toLocaleString()}`;
      document.getElementById("ordersCount").textContent = data.totalOrders || 0;
      document.getElementById("pendingOrders").textContent = data.pendingOrders || 0;
      document.getElementById("processingOrders").textContent = data.processingOrders || 0;

      // replace recent orders
      const tbody = document.querySelector("#recentOrdersTable tbody");
      tbody.innerHTML = "";
      data.recentOrders.forEach(order => {
        const tr = document.createElement("tr");
        tr.dataset.ref = order.reference;
        tr.innerHTML = `
          <td>${order.reference}</td>
          <td>${new Date(order.createdAt).toISOString().split("T")[0]}</td>
          <td><span style="color:${order.status === "delivered" ? "green" : order.status === "processing" ? "orange" : "gray"};font-weight:600;">${order.status}</span></td>
          <td>‚Ç¶${(order.totalAmount||0).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });

    } catch(err) {
      console.error("Failed to fetch dashboard data:", err);
    }
  }

  // initial load
  (function initLocalNotifCount(){
    const saved = getNotifCount();
    setNotifCount(saved);
  })();

  refreshBtn.addEventListener("click", async () => {
    refreshBtn.disabled = true;
    await fetchAndRenderStats();
    setTimeout(()=> refreshBtn.disabled = false, 800);
  });

  notifIcon.addEventListener("click", () => {
    setNotifCount(0);
    window.location.href = "orders.html";
  });

  // ---------- real-time init ----------
  let socket;
  function initRealtime() {
    if (typeof io === "undefined") {
      console.error("‚ùå socket.io client not available");
      return;
    }
    socket = io(backendURL, { transports: ["websocket"], reconnection: true });

    socket.on("connect", () => console.log("‚úÖ Connected to WebSocket server:", socket.id));
    socket.on("disconnect", () => console.warn("‚ö†Ô∏è Disconnected from WebSocket server"));

    // newOrder: show popup, increment bell and refresh recentOrders (light refresh)
    socket.on("newOrder", async (order) => {
      console.log("‚ö° newOrder event:", order);
      // increment bell & popup
      const c = getNotifCount() + 1;
      setNotifCount(c);
      showPopup("New order received!");

      // update counts/UI quickly (optimistic)
      const ordersCountEl = document.getElementById("ordersCount");
      const pendingOrdersEl = document.getElementById("pendingOrders");
      const processingOrdersEl = document.getElementById("processingOrders");
      const revenueEl = document.getElementById("revenue");

      ordersCountEl.textContent = (parseInt(ordersCountEl.textContent)||0) + 1;
      pendingOrdersEl.textContent = (parseInt(pendingOrdersEl.textContent)||0) + (order.status === "pending" ? 1 : 0);
      processingOrdersEl.textContent = (parseInt(processingOrdersEl.textContent)||0) + (order.status === "processing" ? 1 : 0);
      revenueEl.textContent = `‚Ç¶${((parseInt(revenueEl.textContent.replace(/‚Ç¶|,/g,""))||0) + (order.totalAmount||0)).toLocaleString()}`;

      // Add to top of recent orders table
      const tbody = document.querySelector("#recentOrdersTable tbody");
      const tr = document.createElement("tr");
      tr.dataset.ref = order.reference;
      tr.innerHTML = `
        <td>${order.reference}</td>
        <td>${new Date(order.createdAt).toISOString().split("T")[0]}</td>
        <td><span style="color:${order.status === "delivered" ? "green" : order.status === "processing" ? "orange" : "gray"};font-weight:600;">${order.status}</span></td>
        <td>‚Ç¶${(order.totalAmount||0).toLocaleString()}</td>
      `;
      tbody.prepend(tr);

      // As a safety: fetch latest stats in background (debounced)
      debouncedFetchStats();
    });

    // order updated -> update row & stats
    socket.on("orderUpdated", (order) => {
      console.log("üîÅ orderUpdated event:", order);
      // update recent orders table row if present
      const row = document.querySelector(`#recentOrdersTable tbody tr[data-ref="${order.reference}"]`);
      if (row) {
        row.innerHTML = `
          <td>${order.reference}</td>
          <td>${new Date(order.createdAt).toISOString().split("T")[0]}</td>
          <td><span style="color:${order.status === "delivered" ? "green" : order.status === "processing" ? "orange" : "gray"};font-weight:600;">${order.status}</span></td>
          <td>‚Ç¶${(order.totalAmount||0).toLocaleString()}</td>
        `;
      }
      // refresh stats
      debouncedFetchStats();
    });

    // order deleted -> remove row & refresh stats
    socket.on("orderDeleted", ({ reference }) => {
      console.log("üóëÔ∏è orderDeleted event:", reference);
      const row = document.querySelector(`#recentOrdersTable tbody tr[data-ref="${reference}"]`);
      if (row) row.remove();
      debouncedFetchStats();
    });
  }

  // debounce for background fetch
  let _debTimer = null;
  function debouncedFetchStats() {
    if (_debTimer) clearTimeout(_debTimer);
    _debTimer = setTimeout(()=> { fetchAndRenderStats(); _debTimer = null; }, 800);
  }

// ---------- OneSignal setup & diagnostics ----------
window.OneSignal = window.OneSignal || [];
OneSignal.push(function () {
  // ‚úÖ Define worker paths
  OneSignal.SERVICE_WORKER_PARAM = { scope: '/onesignal/' };
  OneSignal.SERVICE_WORKER_PATH = '/onesignal/OneSignalSDKWorker.js';
  OneSignal.SERVICE_WORKER_UPDATER_PATH = '/onesignal/OneSignalSDKUpdaterWorker.js';

  // ‚úÖ Initialize OneSignal
  OneSignal.init({
    appId: "fd07727d-eb83-4e33-b88d-70a1d271a4be",
    safari_web_id: "web.onesignal.auto.1afe2633-50cf-455e-8f3e-a50d8cbe1d12",
    notifyButton: { enable: true },
    allowLocalhostAsSecureOrigin: true,
    subdomainName: "restaurant-plum",
    serviceWorkerPath: '/onesignal/OneSignalSDKWorker.js',
    serviceWorkerUpdaterPath: '/onesignal/OneSignalSDKUpdaterWorker.js',
    serviceWorkerParam: { scope: '/onesignal/' },
    welcomeNotification: {
      title: "Welcome!",
      message: "You‚Äôll now receive notifications for new orders."
    }
  });

  // ---------- Diagnostics ----------
  (async () => {
    try {
      const permission = await OneSignal.getNotificationPermission();
      console.log("üîî Permission:", permission);

      const playerId = await OneSignal.getUserId();
      console.log("üì° Player ID:", playerId || "None");

      const enabled = await OneSignal.isPushNotificationsEnabled();
      console.log("‚úÖ Push Enabled:", enabled);

      if (!enabled) {
        console.log("üîÑ Not subscribed, requesting push registration...");
        await OneSignal.showSlidedownPrompt();
        await OneSignal.registerForPushNotifications();
        const newId = await OneSignal.getUserId();
        console.log("üéØ New Player ID:", newId || "None after prompt");
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è OneSignal diagnostic error:", err);
    }
  })();

  // ‚úÖ Default URL when notification is clicked
  OneSignal.setDefaultNotificationUrl("https://restaurant-plum.vercel.app/admin-dashboard.html");
});
  
  // ---------- service worker registration (unchanged) ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('/service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker registered:', reg.scope))
        .catch(err => console.error('‚ùå SW registration failed:', err));
    });
  }

  // ---------- initial data load ----------
  fetchAndRenderStats();

  // ---------- sidebar toggle ----------
  document.getElementById("toggleMenu").addEventListener("click", () => {
    document.getElementById("sidebar").classList.toggle("active");
  });

  // ---------- logout ----------
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.addEventListener("click", (e) => {
    e.preventDefault();
    if (confirm("Are you sure you want to log out?")) {
      localStorage.removeItem("user");
      localStorage.removeItem("orderNotifCount");
      window.location.href = "login.html";
    }
  });

});
</script>
</body>
      </html>
