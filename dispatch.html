<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TastyBite | Dispatch Orders</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background-color: #fff; color: #333; overflow-x: hidden; }

    header {
      width: 100%; background: #fff; display: flex; justify-content: space-between;
      align-items: center; padding: 15px 5%; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 100;
    }
    .logo { font-size: 1.5rem; font-weight: 700; color: #ff6600; }
    .nav-right { display: flex; align-items: center; gap: 15px; }
    .cart-icon { font-size: 1.4rem; cursor: pointer; color: #ff6600; position: relative; }
    .cart-count {
      position: absolute; top: -6px; right: -10px; background: #ff5500; color: white;
      border-radius: 50%; font-size: 0.7rem; width: 16px; height: 16px;
      display: flex; align-items: center; justify-content: center;
    }

    main { padding: 50px 5%; text-align: center; }
    h2 { color: #ff5500; margin-bottom: 15px; }

    .order-count {
      display: flex; justify-content: center; align-items: center;
      gap: 15px; margin-bottom: 25px;
    }
    .order-count button {
      background: linear-gradient(45deg, #ff8800, #ff5500); border: none; color: #fff;
      padding: 8px 14px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
    }
    .order-count input {
      width: 60px; text-align: center; padding: 6px; font-size: 1rem;
      border: 1px solid #ddd; border-radius: 6px;
    }

    .fetch-btn {
      background: linear-gradient(45deg, #ff8800, #ff5500); border: none; color: white;
      padding: 10px 25px; border-radius: 25px; font-size: 1rem;
      cursor: pointer; margin-top: 10px; transition: 0.3s;
    }
    .fetch-btn:hover { transform: scale(1.05); }
    .fetch-btn:disabled { background: #ccc; cursor: not-allowed; }

    .order-inputs { margin-top: 30px; }
    .order-inputs input {
      display: block; margin: 10px auto; width: 250px; padding: 10px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 0.95rem;
    }

    .order-results {
      margin-top: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    .order-card {
      background: #fff7f0; border-radius: 15px; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: left;
      animation: fadeIn 0.6s ease;
    }
    .order-card h3 { color: #ff6600; margin-bottom: 8px; }
    .order-card p { font-size: 0.9rem; margin-bottom: 4px; }

    .pack-header {
      display: flex; justify-content: space-between; align-items: center;
      background: #ffe4cc; color: #ff7b00; padding: 10px 14px;
      border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 500;
      transition: 0.3s;
    }
    .pack-header:hover { background: #ffd6b3; }
    .arrow { transition: transform 0.3s ease; }
    .pack-header.open .arrow { transform: rotate(180deg); }

    .pack-items {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
      padding: 0 10px;
    }
    .order-item {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px; font-size: 14px;
    }
    .order-item img {
      width: 40px; height: 40px; border-radius: 6px;
      object-fit: cover; margin-right: 10px;
    }
    .item-details { display: flex; align-items: center; flex: 1; }
    .order-total {
      border-top: 1px solid #ccc; padding-top: 10px; font-weight: bold;
      text-align: right; color: #ff7b00; margin-top: 10px;
    }

    .deliver-btn {
      width: 100%; margin-top: 15px;
      background: linear-gradient(45deg, #28a745, #34ce57);
      color: white; border: none; border-radius: 20px;
      padding: 10px; font-size: 0.9rem; font-weight: 500;
      cursor: pointer; transition: 0.3s;
    }
    .deliver-btn:hover { transform: scale(1.05); }
    .deliver-btn:disabled { background: #ccc; cursor: not-allowed; }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 10px 20px;
      border-radius: 25px; display: none; z-index: 1000;
    }

    footer {
      text-align: center; padding: 20px; background: #fff3e6;
      margin-top: 50px; font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">TastyBite</div>
    <div class="nav-right">
      <div class="cart-icon">üõí<span class="cart-count">0</span></div>
    </div>
  </header>

  <main>
    <h2>Dispatch Orders</h2>
    <p>Enter order references to fetch and mark as delivered.</p>

    <div class="order-count">
      <button id="decreaseBtn">‚àí</button>
      <span id="orderCount">1</span>
      <button id="increaseBtn">+</button>
    </div>

    <div class="order-inputs" id="orderIdInputs"></div>
    <button class="fetch-btn" id="fetchBtn">Fetch Orders</button>

    <div class="order-results" id="ordersContainer"></div>
  </main>

  <footer>¬© 2025 TastyBite Restaurant. All rights reserved.</footer>
  <div id="toast"></div>

  <script>
    const BASE_URL = "https://restaurant-eqbo.onrender.com/api/orders";
    const UPDATE_URL = `${BASE_URL}/update`;
    const orderIdInputs = document.getElementById("orderIdInputs");
    const orderCountDisplay = document.getElementById("orderCount");
    const fetchBtn = document.getElementById("fetchBtn");
    const ordersContainer = document.getElementById("ordersContainer");
    const toast = document.getElementById("toast");
    const cartCountEl = document.querySelector(".cart-count");

    cartCountEl.textContent = localStorage.getItem("cartCount") || 0;
    let orderCount = 1;

    const renderInputs = () => {
      orderIdInputs.innerHTML = "";
      for (let i = 0; i < orderCount; i++) {
        const input = document.createElement("input");
        input.placeholder = `Enter Order Reference #${i + 1}`;
        input.classList.add("orderRefInput");
        orderIdInputs.appendChild(input);
      }
    };

    const showToast = (msg, color="#333") => {
      toast.textContent = msg;
      toast.style.background = color;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 2500);
    };

    document.getElementById("increaseBtn").onclick = () => {
      orderCount++;
      orderCountDisplay.textContent = orderCount;
      renderInputs();
    };

    document.getElementById("decreaseBtn").onclick = () => {
      if (orderCount > 1) {
        orderCount--;
        orderCountDisplay.textContent = orderCount;
        renderInputs();
      }
    };

    renderInputs();

    fetchBtn.onclick = async () => {
      const refs = Array.from(document.querySelectorAll(".orderRefInput"))
        .map(i => i.value.trim())
        .filter(Boolean);

      if (!refs.length) return showToast("Enter at least one order reference!", "#e74c3c");

      ordersContainer.innerHTML = "";
      fetchBtn.textContent = "Fetching...";
      fetchBtn.disabled = true;

      for (const ref of refs) {
        try {
          const res = await fetch(`${BASE_URL}/${ref}`);
          const data = await res.json();

          if (!res.ok) {
            ordersContainer.innerHTML += `<div class='order-card'><p>‚ùå ${data.message || "Order not found"} (${ref})</p></div>`;
            continue;
          }

          const order = data;
          const card = document.createElement("div");
          card.classList.add("order-card");
          card.innerHTML = `
            <h3>Reference: ${order.reference}</h3>
            <p><strong>Name:</strong> ${order.name}</p>
            <p><strong>Phone:</strong> ${order.phone}</p>
            <p><strong>Address:</strong> ${order.address}, ${order.junction}</p>
            <div id="packs-${order.reference}"></div>
            <div class="order-total">Total: ‚Ç¶${order.totalAmount.toLocaleString()}</div>
            <button class="deliver-btn">${order.status === "delivered" ? "‚úÖ Delivered" : "Mark as Delivered"}</button>
          `;
          ordersContainer.appendChild(card);

          const packContainer = card.querySelector(`#packs-${order.reference}`);
          order.items.forEach(pack => {
            const packName = Object.keys(pack)[0];
            const packDiv = document.createElement("div");
            packDiv.classList.add("pack");

            const header = document.createElement("div");
            header.classList.add("pack-header");
            header.innerHTML = `<span>${packName}</span><span class="arrow">‚ñº</span>`;

            const itemsContainer = document.createElement("div");
            itemsContainer.classList.add("pack-items");

            pack[packName].forEach(item => {
              const itemDiv = document.createElement("div");
              itemDiv.classList.add("order-item");
              itemDiv.innerHTML = `
                <div class="item-details">
                  <img src="${item.img}" alt="${item.name}">
                  <span>${item.name} (x${item.qty})</span>
                </div>
                <span>‚Ç¶${(item.price * item.qty).toLocaleString()}</span>
              `;
              itemsContainer.appendChild(itemDiv);
            });

            header.addEventListener("click", () => {
              const isOpen = header.classList.toggle("open");
              if (isOpen) {
                itemsContainer.style.maxHeight = itemsContainer.scrollHeight + "px";
                itemsContainer.style.padding = "10px";
              } else {
                itemsContainer.style.maxHeight = "0";
                itemsContainer.style.padding = "0 10px";
              }
            });

            packDiv.appendChild(header);
            packDiv.appendChild(itemsContainer);
            packContainer.appendChild(packDiv);
          });

          const btn = card.querySelector(".deliver-btn");
          btn.onclick = async () => {
            btn.textContent = "Updating...";
            btn.disabled = true;
            try {
              const res = await fetch(`${UPDATE_URL}/${order.reference}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "delivered" }),
              });
              const data = await res.json();
              if (res.ok) {
                btn.textContent = "‚úÖ Delivered";
                showToast(`Order ${order.reference} marked as delivered!`, "#28a745");
              } else {
                throw new Error(data.message);
              }
            } catch {
              btn.textContent = "Mark as Delivered";
              btn.disabled = false;
              showToast("Error updating order!", "#e74c3c");
            }
          };
        } catch {
          ordersContainer.innerHTML += `<div class='order-card'><p>‚ùå Error fetching ${ref}</p></div>`;
        }
      }

      fetchBtn.textContent = "Fetch Orders";
      fetchBtn.disabled = false;
    };
  </script>
</body>
  </html>
