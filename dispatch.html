<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispatch Orders</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #fff8f2;
      color: #333;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(90deg, #ff7b00, #ffb347);
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 22px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .container {
      max-width: 600px;
      margin: 30px auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .input-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .input-section button {
      background: #ff7b00;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 18px;
      cursor: pointer;
    }

    .input-section button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .input-section span {
      font-weight: bold;
      font-size: 16px;
    }

    .order-id-inputs input {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline: none;
    }

    .fetch-btn {
      background: #ff7b00;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.3s;
    }

    .fetch-btn:hover {
      background: #e86f00;
    }

    .order-card {
      background: #fff7f0;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .pack-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ffe4cc;
      color: #ff7b00;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: 500;
      transition: 0.3s;
    }

    .pack-header:hover {
      background: #ffd6b3;
    }

    .arrow {
      transition: transform 0.3s ease;
    }

    .pack-header.open .arrow {
      transform: rotate(180deg);
    }

    .pack-items {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 10px;
    }

    .order-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .order-item img {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
      margin-right: 10px;
    }

    .item-details {
      display: flex;
      align-items: center;
      flex: 1;
    }

    .order-total {
      border-top: 1px solid #ccc;
      padding-top: 10px;
      font-weight: bold;
      text-align: right;
      color: #ff7b00;
      margin-top: 10px;
    }

    .deliver-btn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px;
      width: 100%;
      font-size: 15px;
      margin-top: 10px;
      cursor: pointer;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  </style>
</head>
<body>
  <header>Order Dispatch</header>

  <div class="container">
    <div class="input-section">
      <button id="decreaseBtn">−</button>
      <span id="orderCount">1</span>
      <button id="increaseBtn">+</button>
    </div>

    <div class="order-id-inputs" id="orderIdInputs"></div>

    <button class="fetch-btn" id="fetchBtn">Fetch Order</button>

    <div id="ordersContainer"></div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const BASE_URL = "https://restaurant-eqbo.onrender.com/api/orders";
    const UPDATE_URL = `${BASE_URL}/update`;

    const orderIdInputs = document.getElementById("orderIdInputs");
    const orderCountDisplay = document.getElementById("orderCount");
    const fetchBtn = document.getElementById("fetchBtn");
    const ordersContainer = document.getElementById("ordersContainer");
    const toast = document.getElementById("toast");

    let orderCount = 1;

    const renderInputs = () => {
      orderIdInputs.innerHTML = "";
      for (let i = 0; i < orderCount; i++) {
        const input = document.createElement("input");
        input.placeholder = `Enter Order Reference #${i + 1}`;
        input.classList.add("orderRefInput");
        orderIdInputs.appendChild(input);
      }
    };

    const showToast = (message, bg = "#333") => {
      toast.textContent = message;
      toast.style.background = bg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    };

    document.getElementById("increaseBtn").onclick = () => {
      orderCount++;
      orderCountDisplay.textContent = orderCount;
      renderInputs();
    };

    document.getElementById("decreaseBtn").onclick = () => {
      if (orderCount > 1) {
        orderCount--;
        orderCountDisplay.textContent = orderCount;
        renderInputs();
      }
    };

    renderInputs();

    fetchBtn.onclick = async () => {
      const refs = Array.from(document.querySelectorAll(".orderRefInput"))
        .map(i => i.value.trim())
        .filter(Boolean);

      if (refs.length === 0) return alert("Please enter at least one order reference.");

      ordersContainer.innerHTML = "";
      fetchBtn.textContent = "Fetching...";
      fetchBtn.disabled = true;

      for (const ref of refs) {
        try {
          const res = await fetch(`${BASE_URL}/${ref}`);
          const data = await res.json();

          if (!res.ok) {
            const msg = data.message || "Order not found!";
            ordersContainer.innerHTML += `<div class='order-card'><p>❌ ${msg} (${ref})</p></div>`;
            continue;
          }

          const order = data;
          const card = document.createElement("div");
          card.classList.add("order-card");
          card.innerHTML = `
            <h3>Reference: ${order.reference}</h3>
            <p><strong>Name:</strong> ${order.name}</p>
            <p><strong>Phone:</strong> ${order.phone}</p>
            <p><strong>Address:</strong> ${order.address}, ${order.junction}</p>
            <div id="packs-${order.reference}"></div>
            <div class="order-total">Total: ₦${order.totalAmount.toLocaleString()}</div>
            <button class="deliver-btn">Mark as Delivered</button>
          `;
          ordersContainer.appendChild(card);

          const packContainer = card.querySelector(`#packs-${order.reference}`);

          order.items.forEach(pack => {
            const packName = Object.keys(pack)[0];
            const packDiv = document.createElement("div");
            packDiv.classList.add("pack");

            const header = document.createElement("div");
            header.classList.add("pack-header");
            header.innerHTML = `<span>${packName}</span><span class="arrow">▼</span>`;

            const itemsContainer = document.createElement("div");
            itemsContainer.classList.add("pack-items");

            pack[packName].forEach(item => {
              const itemDiv = document.createElement("div");
              itemDiv.classList.add("order-item");
              itemDiv.innerHTML = `
                <div class="item-details">
                  <img src="${item.img}" alt="${item.name}">
                  <span>${item.name} (x${item.qty})</span>
                </div>
                <span>₦${(item.price * item.qty).toLocaleString()}</span>
              `;
              itemsContainer.appendChild(itemDiv);
            });

            header.addEventListener("click", () => {
              const isOpen = header.classList.toggle("open");
              if (isOpen) {
                itemsContainer.style.maxHeight = itemsContainer.scrollHeight + "px";
                itemsContainer.style.padding = "10px";
              } else {
                itemsContainer.style.maxHeight = "0";
                itemsContainer.style.padding = "0 10px";
              }
            });

            packDiv.appendChild(header);
            packDiv.appendChild(itemsContainer);
            packContainer.appendChild(packDiv);
          });

          const btn = card.querySelector(".deliver-btn");
          btn.onclick = async () => {
            const reference = order.reference;
            btn.textContent = "Updating...";
            btn.disabled = true;

            try {
              const res = await fetch(`${UPDATE_URL}/${reference}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "delivered" }),
              });

              const data = await res.json();
              if (res.ok) {
                btn.textContent = "✅ Delivered";
                showToast(`Order ${reference} marked as delivered!`, "#28a745");
              } else {
                throw new Error(data.message || "Update failed");
              }
            } catch (err) {
              btn.textContent = "Failed";
              btn.disabled = false;
              showToast("Error updating order!", "#e74c3c");
            }
          };
        } catch (err) {
          console.error(err);
          ordersContainer.innerHTML += `<div class='order-card'><p>❌ Error fetching ${ref}</p></div>`;
        }
      }

      fetchBtn.textContent = "Fetch Order";
      fetchBtn.disabled = false;
    };
  </script>
</body>
  </html>
