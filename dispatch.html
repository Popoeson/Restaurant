<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TastyBite | Dispatch Orders</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background-color: #fff; color: #333; overflow-x: hidden; }

    header {
      width: 100%; background: #fff; display: flex; justify-content: space-between;
      align-items: center; padding: 15px 5%; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 100;
    }
    .logo { font-size: 1.5rem; font-weight: 700; color: #ff6600; }
    .nav-right { display: flex; align-items: center; gap: 15px; }
    .cart-icon { font-size: 1.4rem; cursor: pointer; color: #ff6600; position: relative; }
    .cart-count {
      position: absolute; top: -6px; right: -10px; background: #ff5500; color: white;
      border-radius: 50%; font-size: 0.7rem; width: 16px; height: 16px;
      display: flex; align-items: center; justify-content: center;
    }

    main { padding: 50px 5%; text-align: center; }
    h2 { color: #ff5500; margin-bottom: 15px; }

    .order-count {
      display: flex; justify-content: center; align-items: center;
      gap: 15px; margin-bottom: 25px;
    }
    .order-count button {
      background: linear-gradient(45deg, #ff8800, #ff5500); border: none; color: #fff;
      padding: 8px 14px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;
    }
    .order-count input {
      width: 60px; text-align: center; padding: 6px; font-size: 1rem;
      border: 1px solid #ddd; border-radius: 6px;
    }

    .proceed-btn, .fetch-btn {
      background: linear-gradient(45deg, #ff8800, #ff5500); border: none; color: white;
      padding: 10px 25px; border-radius: 25px; font-size: 1rem;
      cursor: pointer; margin-top: 10px; transition: 0.3s;
    }
    .proceed-btn:hover, .fetch-btn:hover { transform: scale(1.05); }
    .fetch-btn:disabled { background: #ccc; cursor: not-allowed; }

    .order-inputs { margin-top: 30px; }
    .order-inputs input {
      display: block; margin: 10px auto; width: 250px; padding: 8px;
      border: 1px solid #ccc; border-radius: 8px; font-size: 0.95rem;
    }

    .order-results {
      margin-top: 40px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    /* ---------- CARD + COLLAPSIBLE STYLING ---------- */
    .order-card {
      background: #fff7f0; border-radius: 15px; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: left;
      animation: fadeIn 0.6s ease;
    }
    .order-card h3 { color: #ff6600; margin-bottom: 8px; }
    .order-card p { font-size: 0.9rem; margin-bottom: 4px; }

    .pack-header {
      display: flex; justify-content: space-between; align-items: center;
      background: #ffe4cc; color: #ff7b00; padding: 10px 14px;
      border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 500;
      transition: 0.3s;
    }
    .pack-header:hover { background: #ffd6b3; }
    .arrow { transition: transform 0.3s ease; }
    .pack-header.open .arrow { transform: rotate(180deg); }

    .pack-items {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
      padding: 0 10px;
    }
    .order-item {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px; font-size: 14px;
    }
    .order-item img {
      width: 40px; height: 40px; border-radius: 6px;
      object-fit: cover; margin-right: 10px;
    }
    .item-details { display: flex; align-items: center; flex: 1; }
    .order-total {
      border-top: 1px solid #ccc; padding-top: 10px; font-weight: bold;
      text-align: right; color: #ff7b00; margin-top: 10px;
    }

    .deliver-btn {
      width: 100%; margin-top: 15px;
      background: linear-gradient(45deg, #28a745, #34ce57);
      color: white; border: none; border-radius: 20px;
      padding: 10px; font-size: 0.9rem; font-weight: 500;
      cursor: pointer; transition: 0.3s;
    }
    .deliver-btn:hover { transform: scale(1.05); }
    .deliver-btn:disabled { background: #ccc; cursor: not-allowed; }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 10px 20px;
      border-radius: 25px; display: none; z-index: 1000;
    }
    footer {
      text-align: center; padding: 20px; background: #fff3e6;
      margin-top: 50px; font-size: 0.9rem;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">TastyBite</div>
    <div class="nav-right">
      <div class="cart-icon">üõí<span class="cart-count">0</span></div>
    </div>
  </header>

  <main>
    <h2>Dispatch Orders</h2>
    <p>Enter how many orders are ready to dispatch.</p>

    <div class="order-count">
      <button id="decrease">-</button>
      <input type="number" id="orderCount" value="1" min="1" />
      <button id="increase">+</button>
    </div>

    <button class="proceed-btn" id="proceedBtn">Proceed</button>

    <div class="order-inputs" id="orderInputs"></div>
    <div class="order-results" id="orderResults"></div>
  </main>

  <footer>¬© 2025 TastyBite Restaurant. All rights reserved.</footer>
  <div id="toast"></div>

  <script>
    const API_BASE = "https://restaurant-eqbo.onrender.com/api/orders";
    const UPDATE_URL = "https://restaurant-eqbo.onrender.com/api/orders/update";

    const orderCountEl = document.getElementById("orderCount");
    const decreaseBtn = document.getElementById("decrease");
    const increaseBtn = document.getElementById("increase");
    const proceedBtn = document.getElementById("proceedBtn");
    const orderInputs = document.getElementById("orderInputs");
    const orderResults = document.getElementById("orderResults");
    const toast = document.getElementById("toast");
    const cartCountEl = document.querySelector(".cart-count");

    // persistent cart count
    cartCountEl.textContent = localStorage.getItem("cartCount") || 0;

    decreaseBtn.onclick = () => { if (orderCountEl.value > 1) orderCountEl.value--; };
    increaseBtn.onclick = () => orderCountEl.value++;

    function showToast(msg, color="#333") {
      toast.textContent = msg;
      toast.style.background = color;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 2500);
    }

    proceedBtn.onclick = () => {
      const count = parseInt(orderCountEl.value);
      orderInputs.innerHTML = "";
      orderResults.innerHTML = "";
      for (let i=1; i<=count; i++) {
        orderInputs.innerHTML += `<input type="text" placeholder="Enter Order Reference ${i}" class="orderRefInput" />`;
      }
      orderInputs.innerHTML += `<button class="fetch-btn" id="fetchOrdersBtn">Fetch Orders</button>`;
      attachFetchHandler();
    };

    function attachFetchHandler() {
      const fetchBtn = document.getElementById("fetchOrdersBtn");
      fetchBtn.onclick = async () => {
        const refs = Array.from(document.querySelectorAll(".orderRefInput")).map(i=>i.value.trim()).filter(Boolean);
        if (!refs.length) return showToast("Please enter at least one order reference!", "#e74c3c");

        fetchBtn.textContent = "Fetching...";
        fetchBtn.disabled = true;
        orderResults.innerHTML = "";

        for (const ref of refs) {
          try {
            const res = await fetch(`${API_BASE}/${ref}`);
            const order = await res.json();

            if (!res.ok || !order.reference) {
              orderResults.innerHTML += `<p style="color:red;">‚ùå Order not found: ${ref}</p>`;
              continue;
            }

            const card = document.createElement("div");
            card.className = "order-card";

            // build collapsible summary
            let packsHTML = "";
            order.items.forEach(packObj => {
              Object.entries(packObj).forEach(([packName, items]) => {
                const packItems = items.map(item => `
                  <div class="order-item">
                    <div class="item-details">
                      <img src="${item.img}" alt="${item.name}" />
                      <span>${item.name} (x${item.qty})</span>
                    </div>
                    <span>‚Ç¶${(item.price * item.qty).toLocaleString()}</span>
                  </div>
                `).join("");

                packsHTML += `
                  <div class="pack">
                    <div class="pack-header"><span>${packName}</span><span class="arrow">‚ñº</span></div>
                    <div class="pack-items">${packItems}</div>
                  </div>`;
              });
            });

            card.innerHTML = `
              <h3>Reference: ${order.reference}</h3>
              <p><strong>Name:</strong> ${order.name}</p>
              <p><strong>Phone:</strong> ${order.phone}</p>
              <p><strong>Address:</strong> ${order.address}</p>
              ${packsHTML}
              <div class="order-total">Total: ‚Ç¶${order.totalAmount.toLocaleString()}</div>
              <button class="deliver-btn" data-id="${order._id}" ${order.status==="delivered"?"disabled":""}>
                ${order.status==="delivered"?"‚úÖ Delivered":"Mark as Delivered"}
              </button>
            `;
            orderResults.appendChild(card);

            // collapse logic
            card.querySelectorAll(".pack-header").forEach(header=>{
              const content = header.nextElementSibling;
              header.addEventListener("click", ()=>{
                const open = header.classList.toggle("open");
                content.style.maxHeight = open ? content.scrollHeight + "px" : "0";
                content.style.padding = open ? "10px" : "0 10px";
              });
            });
          } catch {
            showToast(`Error fetching order ${ref}`, "#e74c3c");
          }
        }

        fetchBtn.textContent = "Fetch Orders";
        fetchBtn.disabled = false;

        document.querySelectorAll(".deliver-btn").forEach(btn=>{
          btn.onclick = async () => {
            const id = btn.dataset.id;
            btn.textContent = "Updating...";
            btn.disabled = true;
            try {
              const res = await fetch(`${UPDATE_URL}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "delivered" }),
              });
              if (res.ok) {
                btn.textContent = "‚úÖ Delivered";
                showToast("Order marked as delivered!", "#28a745");
              } else throw new Error();
            } catch {
              btn.textContent = "Failed";
              btn.disabled = false;
              showToast("Error updating order!", "#e74c3c");
            }
          };
        });
      };
    }
  </script>
</body>
                                                   </html>
